# 最佳实践:监控什么？

> TODO: 补充每个Pattern下，Prometheus中的实际例子

前面部分介绍了Prometheus的数据存储模型以及4种指标类型，同时Promethues提供的强大的PromQL可以实现对数据的个性化处理。Promthues基于指标提供了一个通用的监控解决方案。这里先思考一个基本的问题，在实现监控时，我们到底应该监控哪些对象以及哪些指标？

## 监控所有

在之前**Prometheus简介**部分介绍监控的基本目标，首先是及时发现问题其次是要能够快速对问题进行定位。对于传统监控解决方案而言，用户看到的依然是一个黑盒，用户无法真正了解系统的真正的运行状态。因此Prometheus鼓励用户监控所有的东西。下面列举一些常用的监控维度。

|   级别               | 监控什么                                              |    Exporter                     | 
|--------             |---------                                             |                       ----------|
|   网络               | 网络协议：http、dns、tcp、icmp；网络硬件：路由器，交换机等  | BlockBox Exporter;SMTP Exporter |
|   主机               | 资源用量                                              |     node exporter               |
|   容器               | 资源用量                                              |     cAdvisor                    |
|   应用(包括Library)   |  延迟，错误，QPS，内部状态等                             |     代码中集成Prmometheus Client  |
|   中间件状态          |  资源用量，以及服务状态                                 |     代码中集成Prmometheus Client  |
|   编排工具           |  集群资源用量，调度等                                    |     Kubernetes Components       |

## 度量模式

除了上述介绍的不同监控级别以外。实际上根据不同的系统类型和目标，这里还有一些通用的套路和模式可以使用。

## 4黄金信号

Four Golden Signals是Google针对大量分布式监控的经验总结。主要关注与以下四种类型的指标：延迟，通讯量，错误以及饱和度。

* 延迟：服务请求所需时间。记录用户所有请求所需的时间，同时应该注意区分一下请求的状态。 例如在数据库或者其他关键祸端服务异常触发HTTP 500的情况下，用户也可能会很快得到请求失败的响应内容，如果不加区分计算这些请求的延迟，可能导致计算结果与实际结果产生巨大的差异。除此以外，在微服务中通常提倡“快速失败”，开发人员需要特别注意这些延迟较大的错误，因为这些缓慢的错误会明显影响系统的性能，因此追踪这些错误的延迟也是非常重要的。

* 流量：监控当前系统的流量是多少, 流量对于不同类型的系统而言可能代表不同的含义。例如，对于Web服务而言, 流量通常是每秒HTTP请求量(Bytes)；而对于音频流系统, 流量则可能侧重于网络i/o速率或并发会话；对于存储系统, 流量则代表的是每秒发送和接受的数据量。

* 错误：监控当前系统所有发生的错误。对于一些显式的错误如HTTP 500可以通过在负载均衡器(如Nginx)上进行捕获，而对于一些系统内部的异常，则可能需要直接从服务中添加钩子统计并进行获取。

* 饱和度：度量当前服务的饱和状态如何。强调某些资源(例如，内存,磁盘IO等)受约束的条件限制下，这些资源的例如率是多少。饱和度可以在较高的维度上辅助队系统的负载测量。例如，在相同饱和度下系统是否能够处理更多的流量。 同时还可以利用饱和度对系统做出预测，比如，“磁盘是否可能在4个小时候就满了”。

## USE方法

## RED方法